import { useState, useEffect } from 'react';
import { useParams, useNavigate, useLocation } from 'react-router-dom';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { InputOTP, InputOTPGroup, InputOTPSlot } from '@/components/ui/input-otp';
import { ClientCostBreakdown } from '@/components/ClientCostBreakdown';
import { ClientCostSummary, calculateClientCosts, decodeClientData } from '@/lib/clientPortalUtils';
import { capacitorStorage } from '@/lib/capacitorStorage';
import { ChevronLeft, Lock, Wrench } from 'lucide-react';

const ClientPortal = () => {
  const { clientId } = useParams<{ clientId: string }>();
  const navigate = useNavigate();
  const location = useLocation();

  const [pin, setPin] = useState('');
  const [error, setError] = useState('');
  const [verified, setVerified] = useState(false);
  const [costSummary, setCostSummary] = useState<ClientCostSummary | null>(null);
  const [loading, setLoading] = useState(true);
  const [expectedCode, setExpectedCode] = useState<string | null>(null);

  // Determine mode: on-device (/client/:id) or shared (/client-view#data)
  const isSharedMode = location.pathname === '/client-view';

  useEffect(() => {
    const load = async () => {
      try {
        if (isSharedMode) {
          // Decode data from URL hash
          const hash = location.hash.slice(1);
          if (!hash) {
            setError('No data found in link.');
            setLoading(false);
            return;
          }
          const { data, accessCode } = await decodeClientData(hash);
          setCostSummary(data);
          setExpectedCode(accessCode);
        } else if (clientId) {
          // On-device mode: load from local storage
          const [clients, vehicles, tasks, settings] = await Promise.all([
            capacitorStorage.getClients(),
            capacitorStorage.getVehicles(),
            capacitorStorage.getTasks(),
            capacitorStorage.getSettings(),
          ]);
          const client = clients.find(c => c.id === clientId);
          if (!client) {
            setError('Client not found.');
            setLoading(false);
            return;
          }
          const summary = calculateClientCosts(client, vehicles, tasks, settings.defaultHourlyRate);
          setCostSummary(summary);
          setExpectedCode(client.accessCode || null);
        }
      } catch (e) {
        console.error('Portal load error:', e);
        setError('Failed to load data.');
      }
      setLoading(false);
    };
    load();
  }, [clientId, isSharedMode, location.hash]);

  const handleVerify = () => {
    if (!expectedCode) {
      // No code set â€” allow access
      setVerified(true);
      return;
    }
    if (pin === expectedCode) {
      setVerified(true);
      setError('');
    } else {
      setError('Incorrect code. Please try again.');
      setPin('');
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-background">
        <div className="animate-pulse text-muted-foreground">Loading...</div>
      </div>
    );
  }

  if (error && !costSummary) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-background p-4 gap-4">
        <p className="text-destructive font-semibold">{error}</p>
        <Button variant="outline" onClick={() => navigate('/')}>
          <ChevronLeft className="h-4 w-4 mr-1" /> Back
        </Button>
      </div>
    );
  }

  // PIN screen
  if (!verified && expectedCode) {
    return (
      <div className="min-h-screen bg-background flex flex-col">
        <header className="border-b px-4 py-3 flex items-center gap-2 bg-primary/10">
          <Button variant="ghost" size="icon" onClick={() => navigate('/')} className="h-8 w-8">
            <ChevronLeft className="h-4 w-4" />
          </Button>
          <Wrench className="h-5 w-5 text-primary" />
          <span className="font-bold text-foreground">Client Portal</span>
        </header>

        <div className="flex-1 flex items-center justify-center p-6">
          <Card className="w-full max-w-xs">
            <CardContent className="pt-6 space-y-6 text-center">
              <Lock className="h-10 w-10 mx-auto text-primary" />
              <div>
                <h2 className="font-bold text-lg text-foreground">Enter Access Code</h2>
                <p className="text-xs text-muted-foreground mt-1">
                  Enter the 4-digit code provided by your mechanic
                </p>
              </div>

              <div className="flex justify-center">
                <InputOTP maxLength={4} value={pin} onChange={setPin}>
                  <InputOTPGroup>
                    <InputOTPSlot index={0} />
                    <InputOTPSlot index={1} />
                    <InputOTPSlot index={2} />
                    <InputOTPSlot index={3} />
                  </InputOTPGroup>
                </InputOTP>
              </div>

              {error && <p className="text-destructive text-xs font-medium">{error}</p>}

              <Button onClick={handleVerify} disabled={pin.length < 4} className="w-full">
                View My Costs
              </Button>
            </CardContent>
          </Card>
        </div>
      </div>
    );
  }

  // Cost breakdown view
  return (
    <div className="min-h-screen bg-background flex flex-col">
      <header className="border-b px-4 py-3 flex items-center gap-2 bg-primary/10 sticky top-0 z-10">
        <Button variant="ghost" size="icon" onClick={() => navigate('/')} className="h-8 w-8">
          <ChevronLeft className="h-4 w-4" />
        </Button>
        <Wrench className="h-5 w-5 text-primary" />
        <span className="font-bold text-foreground">Client Portal</span>
      </header>

      <div className="flex-1 overflow-y-auto p-4">
        {costSummary && <ClientCostBreakdown costSummary={costSummary} />}
      </div>
    </div>
  );
};

export default ClientPortal;
